<project default="main">

	<!--
		Steps
	 	Ant properties available at runtime: 
	
	 - eclipse.pdebuild.scripts: the org.eclipse.eclipse.pdebuild.scripts folder
	 - eclipse.pdebuild.home: the root folder of pde build
	 - eclipse.pdebuild.templates: the  templates folder
	
	-->

	<!--build monitoring information:  e-mail, smtp server, build label-->
	<property file="monitor.properties"/>
	
	<!--location of PDE Build configuration files for builder and packager-->
	<property name="eclipse.build.configs" value="${basedir}/eclipse/buildConfigs" />
	
	<property name="sdkHelper" location="${eclipse.build.configs}/eclipse/helper.xml"/>
	<property name="base.builder" value="${basedir}/../BaseBuilder" />
	
	<!--location of properties file containing last tag used for integration build-->
	<property name="mapTag.properties" value="/home/users/releng/buildTools/eclipse33/mapTag.properties"/>
	
	<!--location of properties file containing last performance reference test information-->
	<property name="ref.properties" value="/home/users/releng/buildTools/eclipse.perf/ref33.properties"/>
	
	<!--location of test update site-->
	<property file="${ref.properties}"/>
	
	<!--default buildDirectory-->
	<property name="buildDirectory" value="${basedir}/../src" />
	
	<!--default location for build output, parent to ${buildLabel}-->
	<property name="postingDirectory" value="${buildDirectory}" />

	<target name="main" depends="init">
		<antcall target="buildBirtThirdPartyFeature"/>
		<antcall target="buildBirtFeature"/>
		<antcall target="buildBirtRCPFeature"/>
		<antcall target="buildBirtTestFeature"/>
		<antcall target="unpackUpdateJarsForPackaging"/>
		<antcall target="integrateBirtFeatures"/>
		<antcall target="buildBirtWebViewer"/>
		<parallel failonany="true">
			<sequential>
				<antcall target="CreateDistribute"/>
				<ant antfile="${eclipse.build.configs}/../helper.xml" target="verifyCompile" />
				<antcall target="CreateUpdateSite"/>
			</sequential>
			<sequential>
				<antcall target="buildBirtNLFeature"/>
			</sequential>
		</parallel>
		<!-- start birt JUnit test -->
		<antcall target="runBirtTest"/>
		<antcall target="runBirtPerformance"/>
	</target>

	<target name="init">
		<ant antfile="build.xml" target="init" />
		<property file="${buildDirectory}/label.properties" />
		
		<condition property="fetchTag" value="HEAD">
			<equals arg1="${buildType}" arg2="N" />
		</condition>
		<condition property="forceContextQualifier" value="${buildId}">
			<equals arg1="${buildType}" arg2="N" />
		</condition>
		<!--compiler args-->
		<property name="compilerArg" value="-enableJavadoc -encoding utf-8 -warn:-discouraged,forbidden" />
		<property name="javacSource" value="1.4" />
		<property name="javacTarget" value="1.4" />
		<property name="javacDebugInfo" value="true" />
		<property name="javacFailOnError" value="false" />
		<property name="javacVerbose" value="false" />
		<property name="logExtension" value=".xml" />
		<!--this property required as of Eclipse 3.0 stream builds > 20031126 -->
		<property name="buildingOSGi" value="true" />
		<!--zip args-->
		<property name="zipargs" value="-y -qq" />
		<!--unzip args-->
		<property name="unzipArgs" value="-qq" />
	</target>
	
	<target name="buildBirtFeature">
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="preBuild">
			<property name="builder" value="${eclipse.build.configs}/birt" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="fetch">
			<property name="builder" value="${eclipse.build.configs}/birt" />
		</ant>
		<!--
		<ant antfile="${eclipse.build.configs}/birt/tools/VersionUpdater.xml" >
		        <property file="${eclipse.build.configs}/birt/build.properties"/>
		</ant>
		<ant antfile="${eclipse.build.configs}/birt/tools/VersionUpdater.xml" target="updatePluginVersion.new" >
		        <property file="${eclipse.build.configs}/birt/build.properties"/>
		</ant>
		-->
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="generate">
			<property name="builder" value="${eclipse.build.configs}/birt" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="process">
			<property name="builder" value="${eclipse.build.configs}/birt" />
		</ant>		
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="assemble">
			<property name="builder" value="${eclipse.build.configs}/birt" />
		</ant>		
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="package">
			<property name="builder" value="${eclipse.build.configs}/birt" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="postBuild">
			<property name="builder" value="${eclipse.build.configs}/birt" />
		</ant>
	</target>

	<target name="CreateDistribute">
		<mkdir dir="${postingDirectory}/${buildLabel}"/>
		<!-- create Runtime -->
		<property file="${buildDirectory}/finalPluginsVersions.properties"/>
		
		<!-- copy runtime to ${buildDirectory}/${buildLabel}/eclipse/plugins/org.eclipse.birt.integration.wtp_${org.eclipse.birt.integration.wtp}/runtime -->
		<ant antfile="BIRTDownloadSetup.xml" dir="${eclipse.build.configs}/birt/tools" target="createWebViewerExample">
			<property name="OutputDir" value="${buildDirectory}/${buildLabel}/eclipse/plugins/org.eclipse.birt.integration.wtp.ui_${org.eclipse.birt.integration.wtp.ui}/runtime" />
			<property name="deposit" value="${buildDirectory}/${buildLabel}" />
		</ant>
			
		<!-- create AllInOne,AllInOne for Linux, RCP, FrameworkSDK,Framework,Chart,BIRTSample,TestSuite,Database -->
		<ant antfile="BIRTDownloadSetup.xml" dir="${eclipse.build.configs}/birt/tools" target="default">
			<property name="OutputDir" value="${postingDirectory}/${buildLabel}" />
			<property name="deposit" value="${buildDirectory}/${buildLabel}" />
		</ant>
		<!-- copy directory.txt to output directory -->
		<copy tofile="${postingDirectory}/${buildLabel}/directory.txt" file="${buildDirectory}/directory.txt"/>
		<!-- Send build ready mail to QA -->
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="InformQA"/>
	</target>
	
	<target name="CreateUpdateSite">
		<property name="updateJarWorkingDir" value="${buildDirectory}/updateJars" />
		<mkdir dir="${updateJarWorkingDir}" />
		<mkdir dir="${updateJarWorkingDir}/site" />
		
		<exec executable="unzip" dir="${buildDirectory}/${buildLabel}">
			<arg line="-o -q birt-report-framework-sdk-2_2_0.bak.zip -d ${updateJarWorkingDir}" />
		</exec>
		<exec executable="unzip" dir="${buildDirectory}/${buildLabel}">
			<arg line="-o -q birt-third-party-2_2_0.bak.zip -d ${updateJarWorkingDir}" />
		</exec>

		<delete includeemptydirs="true">
			<fileset dir="${updateJarWorkingDir}/eclipse/features" includes="*.thirdparty*/**" />
			<fileset dir="${updateJarWorkingDir}/eclipse/plugins" includes="*.thirdparty*/**" />
		</delete>
		
		<!-- repack plugin org.eclipse.birt.integration.wtp.ui to include birt.zip in runtime sub-folder -->
		<property file="${buildDirectory}/finalPluginsVersions.properties"/>
		<delete file="${updateJarWorkingDir}/eclipse/plugins/org.eclipse.birt.integration.wtp.ui_${org.eclipse.birt.integration.wtp.ui}.jar"/>
		<jar destfile="${updateJarWorkingDir}/eclipse/plugins/org.eclipse.birt.integration.wtp.ui_${org.eclipse.birt.integration.wtp.ui}.jar" 
			basedir="${buildDirectory}/${buildLabel}/eclipse/plugins/org.eclipse.birt.integration.wtp.ui_${org.eclipse.birt.integration.wtp.ui}"/>
		
		<!-- TODO:sign update jars -->
		
		<!-- repack update jar -->
		<replace file="${eclipse.build.configs}/../../extras/pack200" token="@pack200@" value="${jvm15_home}/bin/pack200"/>
		<chmod file="${eclipse.build.configs}/../../extras/pack200" perm="755"/>
		<exec executable="dos2unix" dir="${eclipse.build.configs}/../../extras">
			<arg line=" pack200" />
		</exec>
		<java jar="${buildDirectory}/../eclipse/startup.jar"
				fork="true"
				timeout="10800000"
				jvm="${jvm15_home}/bin/java"
				failonerror="true"
				maxmemory="512m"
				dir="${buildDirectory}">
			<jvmarg value="-Dorg.eclipse.update.jarprocessor.pack200=${eclipse.build.configs}/../../extras"/>
			<arg line="-application org.eclipse.update.core.siteOptimizer"/>
			<arg line="-jarProcessor -outputDir ${updateJarWorkingDir}/site -processAll -repack updateJars/eclipse"/>
		</java>
		
		<!-- create Pack200 update jars -->
		<!--
		<java jar="${buildDirectory}/../eclipse/startup.jar"
				fork="true"
				timeout="10800000"
				jvm="${jvm15_home}/bin/java"
				failonerror="true"
				maxmemory="512m"
				dir="${buildDirectory}">
			<jvmarg value="-Dorg.eclipse.update.jarprocessor.pack200=${eclipse.build.configs}/../../extras"/>
			<arg line="-application org.eclipse.update.core.siteOptimizer"/>
			<arg line="-jarProcessor -outputDir ${updateJarWorkingDir}/site -processAll -pack updateJars/eclipse"/>
		</java>
		-->
		<!-- generate site.xml -->
		<property file="${buildDirectory}/finalFeaturesVersions.properties"/>
		<copy file="${eclipse.build.configs}/../../extras/site.xml" tofile="${updateJarWorkingDir}/site/site.xml"/>
		<!-- replace the feature version in site.xml -->
		<replace file="${updateJarWorkingDir}/site/site.xml" value="${com.lowagie.itext}" token="@FEATURE.ITEXT@"/>
		<replace file="${updateJarWorkingDir}/site/site.xml" value="${org.apache.commons.codec}" token="@FEATURE.CODEC@"/>
		<replace file="${updateJarWorkingDir}/site/site.xml" value="${org.mozilla.rhino}" token="@FEATURE.MOZILLA@"/>
		<replace file="${updateJarWorkingDir}/site/site.xml" value="${org.w3c.sac}" token="@FEATURE.W3C@"/>
		<replace file="${updateJarWorkingDir}/site/site.xml" value="${org.apache.batik}" token="@FEATURE.BATIK@"/>
		<replace file="${updateJarWorkingDir}/site/site.xml" value="${org.apache.batik.pdf}" token="@FEATURE.BATIK.PDF@"/>
		<replace file="${updateJarWorkingDir}/site/site.xml" value="${org.eclipse.birt}" token="@FEATURE.BIRT@"/>
		<replace file="${updateJarWorkingDir}/site/site.xml" value="${org.eclipse.birt.sdk}" token="@FEATURE.BIRT.SDK@"/>
		
		<!-- push update site to output directory -->
		<mkdir dir="${postingDirectory}/${buildLabel}/UpdateSite"/>
		<copy todir="${postingDirectory}/${buildLabel}/UpdateSite">
			<fileset dir="${updateJarWorkingDir}/site">
				<include name="**"/>
			</fileset>
		</copy>
		<!-- copy to internal update site -->
		<copy todir="${postingDirectory}/../../../UpdateSite/plugins" overwrite="true">
			<fileset dir="${updateJarWorkingDir}/site/plugins">
				<include name="**"/>
			</fileset>
		</copy>
		<copy todir="${postingDirectory}/../../../UpdateSite/features" overwrite="true">
			<fileset dir="${updateJarWorkingDir}/site/features/">
				<include name="**"/>
			</fileset>
		</copy>
		<copy tofile="${postingDirectory}/../../../UpdateSite/site.xml" file="${updateJarWorkingDir}/site/site.xml" overwrite="true"/>
	</target>
	
	<target name="runBirtTest">
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="runBirtTest" >
			<property name="runner.dir" value="${eclipse.build.configs}/birt.tests/test.scripts" />
		</ant>
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="InformAutomation" >
			<property name="runner.dir" value="${eclipse.build.configs}/birt.tests/test.scripts" />
		</ant>		
	</target>
	
	<target name="runBirtPerformance">
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="runBirtPerformance" >
			<property name="runner.dir" value="${eclipse.build.configs}/birt.tests/test.scripts" />
		</ant>
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="InformPerformance" >
			<property name="runner.dir" value="${eclipse.build.configs}/birt.tests/test.scripts" />
		</ant>
	</target>
	
	<target name="buildBirtTestFeature">
		<ant antfile="build.xml" dir="${basedir}">
			<property name="component" value="${eclipse.build.configs}/birt.tests" />
		</ant>
	</target>
	
	<target name="buildBirtThirdPartyFeature">
		<ant antfile="build.xml" dir="${basedir}">
			<property name="component" value="${eclipse.build.configs}/birt.third.party" />
		</ant>
	</target>
	<!-- - - - - - - - - - - - - - - - - - 
          target: buildBirtRCPFeature                      
         - - - - - - - - - - - - - - - - - -->
    <target name="buildBirtRCPFeature">
		<ant antfile="build.xml" dir="${basedir}">
			<property name="component" value="${eclipse.build.configs}/birt.rcp" />
		</ant>           
    </target>

	<target name="buildBirtNLFeature">
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="preBuild">
			<property name="builder" value="${eclipse.build.configs}/birt.nl" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="fetch">
			<property name="builder" value="${eclipse.build.configs}/birt.nl" />
		</ant>
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="buildLanguagePack" />
		
	</target>
	
	<target name="buildUpdateSite" if="updateSite">
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="buildUpdateJars" />
	</target>
	
	<target name="unpackUpdateJarsForPackaging">

		<property name="tmpsite" value="${buildDirectory}/tmpsite" />
		<property name="tmpsite2" value="${buildDirectory}/tmpsite2" />
		<mkdir dir="${tmpsite}/new/eclipse/features" />
		<mkdir dir="${tmpsite}/new/eclipse/plugins" />
		<mkdir dir="${tmpsite2}/new/eclipse/features" />
		<mkdir dir="${tmpsite2}/new/eclipse/plugins" />

		<!-- BIRT framework-->
		<exec executable="unzip" dir="${buildDirectory}/${buildLabel}">
			<arg line="-q birt-report-framework-sdk-2_2_0.zip -d ${tmpsite}" />
		</exec>
		<unpackUpdateJars site="${tmpsite}/eclipse" output="${tmpsite}/new/eclipse"/>
		<!-- BIRT third party -->
		<exec executable="unzip" dir="${buildDirectory}/${buildLabel}">
			<arg line="-q birt-third-party-2_2_0.zip -d ${tmpsite2}" />
		</exec>
		<unpackUpdateJars site="${tmpsite2}/eclipse" output="${tmpsite2}/new/eclipse"/>

		<exec executable="unzip" dir="${buildDirectory}/${buildLabel}">
			<arg line="-o -q birt-report-framework-sdk-2_2_0.zip -d ${tmpsite}" />
		</exec>
		<exec executable="unzip" dir="${buildDirectory}/${buildLabel}">
			<arg line="-o -q birt-third-party-2_2_0.zip -d ${tmpsite2}" />
		</exec>

		<move file="${buildDirectory}/${buildLabel}/birt-report-framework-sdk-2_2_0.zip" tofile="${buildDirectory}/${buildLabel}/birt-report-framework-sdk-2_2_0.bak.zip" />
		<move file="${buildDirectory}/${buildLabel}/birt-third-party-2_2_0.zip" tofile="${buildDirectory}/${buildLabel}/birt-third-party-2_2_0.bak.zip" />

		<exec executable="zip" dir="${tmpsite}/new">
			<arg line="-q ${buildDirectory}/${buildLabel}/birt-report-framework-sdk-2_2_0.zip -r eclipse" />
		</exec>
		<exec executable="zip" dir="${tmpsite2}/new">
			<arg line="-q ${buildDirectory}/${buildLabel}/birt-third-party-2_2_0.zip -r eclipse" />
		</exec>	
	</target>

	<target name="integrateBirtFeatures" >

		<property name="birtFramePackageName" value="birt-report-framework-sdk-2_2_0" />
		<property name="birtThirdPartyPackageName" value="birt-third-party-2_2_0" />
		<property name="birtRCPPackageName" value="birt-rcp-2_2_0" />
		
		<exec executable="unzip" dir="${buildDirectory}/${buildLabel}">
			<arg line="-o -q ${birtFramePackageName}.zip -d ${buildDirectory}/${buildLabel}" />
		</exec>
		<exec executable="unzip" dir="${buildDirectory}/${buildLabel}">
			<arg line="-o -q ${birtThirdPartyPackageName}.zip -d ${buildDirectory}/${buildLabel}" />
		</exec>
		<exec executable="unzip" dir="${buildDirectory}/${buildLabel}">
			<arg line="-o -q ${birtRCPPackageName}.zip -d ${buildDirectory}/${buildLabel}" />
		</exec>
	</target>

	<target name="package">
		<ant antfile="package.xml" dir="${eclipse.pdebuild.scripts}">
			<property name="packagingInfo" value="${packagingInfo}" />
			<property name="assemblyTempDir" value="${packagingInfo}/jartmp" />
		</ant>
	</target>
	
    <target name="buildBirtWebViewer">
            <ant antfile="${eclipse.build.configs}/../helper.xml" target="BuildWebViewer" >
            </ant>
    </target>


</project>
