<project default="main">

	<!--
		Steps
	 	Ant properties available at runtime: 
	
	 - eclipse.pdebuild.scripts: the org.eclipse.eclipse.pdebuild.scripts folder
	 - eclipse.pdebuild.home: the root folder of pde build
	 - eclipse.pdebuild.templates: the  templates folder
	
	-->

	<!--build monitoring information:  e-mail, smtp server, build label-->
	<property file="monitor.properties"/>
	
	<!--location of PDE Build configuration files for builder and packager-->
	<property name="eclipse.build.configs" value="${basedir}/eclipse/buildConfigs" />
	
	<property name="base.builder" value="${basedir}/../org.eclipse.releng.basebuilder" />
	
	<!--location of properties file containing last tag used for integration build-->
	<property name="mapTag.properties" value="/home/users/releng/buildTools/eclipse33/mapTag.properties"/>
	
	
	<!--default buildDirectory-->
	<property name="buildDirectory" value="${basedir}/../src" />
	
	<!--default location for build output, parent to ${buildId}-->
	<property name="postingDirectory" value="${buildDirectory}" />

    <!--remote sign machine login infomation-->
    <property name="username.sign" value="" />
    <property name="password.sign" value="" />
    <property name="hostname.sign" value="" />
    <property name="home.dir" value="" />
    <property name="sign.dir" value="" />

	<target name="main" depends="init">
		
		<antcall target="buildBirtThirdPartyFeature"/>
		<antcall target="buildBirtFeature"/>
		<antcall target="fetchBirtWtpFeature"/>
		<antcall target="fetchRCP"/>
		<antcall target="buildBirtRCPFeature"/>
		<antcall target="buildBirtTestFeature"/>
		<antcall target="unpackUpdateJarsForPackaging"/>
		<antcall target="buildBirtWebViewer"/>
		<antcall target="BuildChartViewer"/>
		<antcall target="CreateDistribute"/>
		
		<parallel failonany="true">
			<sequential>	
				<antcall target="buildBirtWtpFeature"/>
				<antcall target="CreateUpdateSite"/>							
			</sequential>
			<sequential>
				<antcall target="buildBirtNLFeature"/>			
				<antcall target="iPortalSetup"/>
				<!--
				<antcall target="generateJavaCrossReference"/>
				<antcall target="generateDocumentCheck"/>
				<antcall target="generateJavaDoc"/>   
				-->     
			</sequential>
		</parallel>

		<!-- <antcall target="runBirtTest"/> -->
		<!--
        <antcall target="runBirtPerformance"/>
		-->
	</target>

	<target name="init">
		
		<ant antfile="build.xml" target="init" />
		
		<property file="${buildDirectory}/label.properties" />
		
		<condition property="fetchTag" value="HEAD">
			<equals arg1="${buildType}" arg2="N" />
		</condition>
		
		<condition property="forceContextQualifier" value="${buildId}">
			<equals arg1="${buildType}" arg2="N" />
		</condition>
		
		<condition property="generateFeatureVersionSuffix" value="false">
			<equals arg1="${buildType}" arg2="N" />
		</condition>
		
		<condition property="createUpdateSite" value="true">
			<equals arg1="${buildType}" arg2="I" />
		</condition>
		
		<!--compiler args-->
		<property name="compilerArg" value="-enableJavadoc -encoding utf-8 -warn:-discouraged,forbidden" />
		<property name="javacSource" value="1.5" />
		<property name="javacTarget" value="1.5" />
		<property name="javacDebugInfo" value="true" />
		<property name="javacFailOnError" value="false" />
		<property name="javacVerbose" value="false" />
		<property name="logExtension" value=".xml" />
		<!--this property required as of Eclipse 3.0 stream builds > 20031126 -->
		<property name="buildingOSGi" value="true" />
		<!--zip args-->
		<property name="zipargs" value="-y -qq" />
		<!--unzip args-->
		<property name="unzipArgs" value="-qq" />
	</target>
	
	<target name="buildBirtFeature">
		<echo message="BIRT sdk feature build started"/>
		
		<ant antfile="build.xml" dir="${basedir}">
			<property name="component" value="${eclipse.build.configs}/birt" />
        </ant>
		<echo message="BIRT sdk feature build finished"/>
	</target>

	<target name="CreateDistribute">
		<echo message="Packaging started"/>
		<mkdir dir="${postingDirectory}/${buildId}"/>
		
		<!-- generate genReport.sh/.bat for birt-runtime-package -->
		<property name="template.dir" value="${baseLocation}/../PackageFiles/template"/>
		<delete>
			<fileset dir="${template.dir}/engine.runtime.bin">
				<include name="*.*"/>
			</fileset>
		</delete>
		
		<exec executable="${eclipse.build.configs}/../../extras/genReportGenerator.sh">
			<arg line="${buildDirectory}/${buildId}/birt_web/org.eclipse.birt.report.viewer/birt_web/WEB-INF/platform/lib" />
			<arg line="${template.dir}/engine.runtime.bin" />
		</exec>
		<!-- create Runtime -->
		<property file="${buildDirectory}/finalPluginsVersions.properties"/>
		
		<!-- copy runtime to ${buildDirectory}/${buildId}/eclipse/plugins/org.eclipse.birt.integration.wtp_${org.eclipse.birt.integration.wtp}/runtime -->
		<ant antfile="BIRTDownloadSetup.xml" dir="${eclipse.build.configs}/birt/tools" target="createWebViewerExample">
			<property name="OutputDir" value="${buildDirectory}/plugins/org.eclipse.birt.integration.wtp.ui/runtime" />
			<property name="deposit" value="${buildDirectory}/${buildId}" />
		</ant>
			
		<!-- copy chart runtime to ${buildDirectory}/${buildId}/eclipse/plugins/org.eclipse.birt.chart.integration.wtp.ui_${org.eclipse.birt.chart.integration.wtp.ui}/runtime -->
		<ant antfile="BIRTDownloadSetup.xml" dir="${eclipse.build.configs}/birt/tools" target="createChartViewer">
			<property name="runtime.tmp" value="${buildDirectory}/plugins/org.eclipse.birt.chart.integration.wtp.ui/runtime" />
		</ant>
		<!-- fix bugzilla bug 225500 -->

		<property name="temp.dir" value="${buildDirectory}/plugins/org.eclipse.birt.chart.integration.wtp.ui/runtime"/>
		<mkdir dir="${temp.dir}/chart-viewer-sample"/>
		<exec executable="unzip" dir="${temp.dir}/">
            <arg line="-q chart-viewer-sample.war -d ${temp.dir}/chart-viewer-sample" />
        </exec>
		
		<delete file="${temp.dir}/chart-viewer-sample.war" failonerror="false"/>
		<delete file="${temp.dir}/chart-viewer-sample/WEB-INF/web.xml" failonerror="false"/>
		<!--
                <exec executable="zip" dir="${temp.dir}/chart-viewer-sample">
                        <arg line="-q ${temp.dir}/chart.zip -r *.* WEB-INF/ META-INF/" />
                </exec>
		-->
        <exec executable="/bin/sh" dir="${temp.dir}/chart-viewer-sample">
            <arg value="-c"/>
            <arg value="zip -r -q ${temp.dir}/chart.zip *" />
        </exec>

		<delete dir="${temp.dir}/chart-viewer-sample" failonerror="false"/>


		<!-- create AllInOne,AllInOne for Linux, RCP, FrameworkSDK,Framework,Chart,BIRTSample,TestSuite,Database -->
		<ant antfile="BIRTDownloadSetup.xml" dir="${eclipse.build.configs}/birt/tools" target="default">
			<property name="OutputDir" value="${postingDirectory}/${buildId}" />
			<property name="deposit" value="${buildDirectory}/${buildId}" />
		</ant>

		<echo message="Packaging finished"/>
		

	</target>

	<target name="sendNotification" unless="nomail">
		<!-- copy directory.txt to output directory -->
		<copy tofile="${postingDirectory}/${buildId}/directory.txt" file="${buildDirectory}/directory.txt"/>
		<copy tofile="${postingDirectory}/monitor.properties" file="monitor.properties" overwrite="true" />
		<copy tofile="${postingDirectory}/finalPluginsVersions.properties" file="${buildDirectory}/finalPluginsVersions.properties" overwrite="true" />
		<copy tofile="${postingDirectory}/finalFeaturesVersions.properties" file="${buildDirectory}/finalFeaturesVersions.properties" overwrite="true" />
        <!--copy build and update dtp log to output directory-->
        <copy todir="${postingDirectory}/${buildId}">
            <fileset dir="." includes="*.log"/>
        </copy>
		<!-- Send build ready mail to QA -->
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="InformQA"/>
	</target>
	
	<target name="iPortalSetup">
		<ant antfile="BIRTDownloadSetup.xml" dir="${eclipse.build.configs}/birt/tools" target="createIpotalLib">
			<property name="OutputDir" value="${postingDirectory}/${buildId}" />
			<property name="deposit" value="${buildDirectory}/${buildId}" />
		</ant>
		
        <!--copy all packages to upload area-->
		<echo message="start copying to download area..."/>
	    <echo message="from dir: ${postingDirectory}/${buildId}"/>
        <copy todir="${test.dir}/../../downloads/${package.version}" failonerror="false" overwrite="true">
	        <fileset dir="${postingDirectory}/${buildId}" >
                <include name="*.zip"/>
                <include name="*.txt"/>
                <include name="*.gz"/>
            </fileset>
	        <fileset dir="${buildDirectory}" >
                <include name="directory.txt"/>
		    </fileset>
            <fileset file="monitor.properties"/>
	    </copy>
		
		<antcall target="renameBirtPackage"/>
        
		<antcall target="sendNotification"/> 
		
	</target>
	
	<target name="renameBirtPackage" unless="skip.rename.package">
		<move file="${postingDirectory}/${buildId}/birt-charts-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/birt-charts-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/birt-database-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/birt-database-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/birt-rcp-report-designer-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/birt-rcp-report-designer-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/birt-report-designer-all-in-one-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/birt-report-designer-all-in-one-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/birt-report-designer-all-in-one-${package.version}-linux-gtk.tar.gz"
        tofile="${postingDirectory}/${buildId}/birt-report-designer-all-in-one-${package.version}-${build.date}-linux-gtk.tar.gz"/>
		<move file="${postingDirectory}/${buildId}/birt-report-framework-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/birt-report-framework-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/birt-report-framework-sdk-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/birt-report-framework-sdk-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/birt-runtime-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/birt-runtime-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/birt-sample-plugins-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/birt-sample-plugins-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/birt-source-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/birt-source-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/birt-tests-suite-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/birt-tests-suite-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/NLpack1_FeatureOverlay-birt-charts-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/NLpack1_FeatureOverlay-birt-charts-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/NLpack1_FeatureOverlay-birt-rcp-report-designer-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/NLpack1_FeatureOverlay-birt-rcp-report-designer-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/NLpack1_FeatureOverlay-birt-report-all-in-one-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/NLpack1_FeatureOverlay-birt-report-all-in-one-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/NLpack1_FeatureOverlay-birt-report-framework-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/NLpack1_FeatureOverlay-birt-report-framework-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/NLpack1-birt-charts-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/NLpack1-birt-charts-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/NLpack1-birt-rcp-report-designer-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/NLpack1-birt-rcp-report-designer-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/NLpack1-birt-report-designer-all-in-one-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/NLpack1-birt-report-designer-all-in-one-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/NLpack1-birt-report-framework-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/NLpack1-birt-report-framework-${package.version}-${build.date}.zip"/>
		<move file="${postingDirectory}/${buildId}/NLpack1-birt-runtime-${package.version}.zip"
                    tofile="${postingDirectory}/${buildId}/NLpack1-birt-runtime-${package.version}-${build.date}.zip"/>
	</target>

	<target name="renameBirtWtpPackage" unless="skip.rename.package">
		<move file="${postingDirectory}/${buildId}/birt-wtp-integration-sdk-${package.version}.zip"
           tofile="${postingDirectory}/${buildId}/birt-wtp-integration-sdk-${package.version}-${build.date}.zip"/>
	</target>
	
	<target name="CreateUpdateSite" if="updateSite">
		
		<property name="updateJarWorkingDir" value="${buildDirectory}/updateJars" />
		<mkdir dir="${updateJarWorkingDir}" />
		<mkdir dir="${updateJarWorkingDir}/site" />
		
		<exec executable="unzip" dir="${buildDirectory}">
			<arg line="-o -q birt-all-${package.version}.sign.zip -d ${updateJarWorkingDir}" />
		</exec>
		<exec executable="unzip" dir="${buildDirectory}/${buildId}">
			<arg line="-o -q birt-wtp-integration-sdk-${package.version}.zip -d ${updateJarWorkingDir}" />
		</exec>

		<delete includeemptydirs="true">
			<fileset dir="${updateJarWorkingDir}/eclipse/features" includes="*.thirdparty*/**" />
			<fileset dir="${updateJarWorkingDir}/eclipse/plugins" includes="*.thirdparty*/**" />
		</delete>
		
		<!-- repack update jar -->
		<replace file="${eclipse.build.configs}/../../extras/pack200" token="@pack200@" value="${jvm15_home}/bin/pack200"/>
		<chmod file="${eclipse.build.configs}/../../extras/pack200" perm="755"/>

		<exec executable="dos2unix" dir="${eclipse.build.configs}/../../extras">
			<arg line=" pack200" />
		</exec>
		
		<antcall target="generateCategory"/>
		<!-- TODO: generate p2 composite update site -->
                <antcall target="GenP2CompositeUpdateSite"/>
                
		<!-- TODO: push to local update site -->
		<antcall target = "pushUpdateSiteLocal"/>
		
		<!--
		<java jar="${basedir}/../org.eclipse.releng.basebuilder/plugins/org.eclipse.equinox.launcher.jar"
				fork="true"
				timeout="10800000"
				jvm="${jvm15_home}/bin/java"
				failonerror="true"
				maxmemory="512m"
				dir="${buildDirectory}">
			<jvmarg value="-Dorg.eclipse.update.jarprocessor.pack200=${eclipse.build.configs}/../../extras"/>
			<arg line="-application org.eclipse.update.core.siteOptimizer"/>
			<arg line="-jarProcessor -outputDir ${updateJarWorkingDir}/site -processAll -repack updateJars/eclipse"/>
		</java>
		-->
		
		<!-- create Pack200 update jars -->
		<!--
		<java jar="${basedir}/../org.eclipse.releng.basebuilder/plugins/org.eclipse.equinox.launcher.jar"
				fork="true"
				timeout="10800000"
				jvm="${jvm15_home}/bin/java"
				failonerror="true"
				maxmemory="512m"
				dir="${buildDirectory}">
			<jvmarg value="-Dorg.eclipse.update.jarprocessor.pack200=${eclipse.build.configs}/../../extras"/>
			<arg line="-application org.eclipse.update.core.siteOptimizer"/>
			<arg line="-jarProcessor -outputDir ${updateJarWorkingDir}/site -processAll -pack updateJars/eclipse"/>
		</java>
		-->
	</target>

        <target name="GenP2CompositeUpdateSite" unless="createUpdateSite">
            <property name="compsite.site" value="${postingDirectory}/../../../UpdateSite/${updateSite}" />
            <property name="repo" value="${compsite.site}/${buildId}" />
            <property name="p2.repo.name" value="BIRT TEST" />
            <mkdir dir="${repo}" />
            
            <!--generator features and plugins metadata -->
            <p2.generator source="${updateJarWorkingDir}/eclipse" compress="true" append="true" flavor="tooling"
                          metadataRepository="file:${repo}"
                          artifactRepository="file:${repo}"
                          metadataRepositoryName="${p2.repo.name}"
                          artifactRepositoryName="${p2.repo.name}"
                          publishArtifacts="true" p2OS="linux" mode="incremental"
                          site="file:${updateJarWorkingDir}/site/site.xml"/>
            
            <!--try create composite repository-->
            <p2.composite.artifact.repository.create location="file://${compsite.site}" name="${p2.repo.name}" compressed="true" failOnExists="false" />
            <p2.composite.metadata.repository.create location="file://${compsite.site}" name="${p2.repo.name}" compressed="true" failOnExists="false" />

            <!--add childRepo to composite repo-->
            <p2.composite.artifact.repository.add location="file://${compsite.site}" child="${buildId}" />
            <p2.composite.metadata.repository.add location="file://${compsite.site}" child="${buildId}" />

        </target>
	
	<target name="generateCategory">

		<property name="updateJarWorkingDir" value="${buildDirectory}/updateJars" />
	    <!-- generate site.xml -->
	    <property file="${buildDirectory}/finalFeaturesVersions.properties"/>
	    <copy file="${eclipse.build.configs}/../../extras/site.xml" tofile="${updateJarWorkingDir}/site/site.xml"/>
	    <!-- replace the feature version in site.xml -->
	    <replace file="${updateJarWorkingDir}/site/site.xml" value="${com.lowagie.itext}" token="@FEATURE.ITEXT@"/>
	    <replace file="${updateJarWorkingDir}/site/site.xml" value="${org.apache.commons.codec}" token="@FEATURE.CODEC@"/>
	    <replace file="${updateJarWorkingDir}/site/site.xml" value="${org.mozilla.rhino}" token="@FEATURE.MOZILLA@"/>
	    <replace file="${updateJarWorkingDir}/site/site.xml" value="${org.w3c.sac}" token="@FEATURE.W3C@"/>
	    <replace file="${updateJarWorkingDir}/site/site.xml" value="${org.eclipse.birt}" token="@FEATURE.BIRT@"/>
	    <replace file="${updateJarWorkingDir}/site/site.xml" value="${org.eclipse.birt.sdk}" token="@FEATURE.BIRT.SDK@"/>
	    <replace file="${updateJarWorkingDir}/site/site.xml" value="${org.eclipse.birt.doc}" token="@FEATURE.BIRT.DOC@"/>
	    <replace file="${updateJarWorkingDir}/site/site.xml" value="${org.eclipse.birt.integration.wtp.sdk}" token="@FEATURE.BIRT.WTP.SDK@"/>
	    <replace file="${updateJarWorkingDir}/site/site.xml" value="${org.eclipse.birt.integration.wtp}" token="@FEATURE.BIRT.WTP@"/>
	    <replace file="${updateJarWorkingDir}/site/site.xml" value="${org.eclipse.birt.chart.integration.wtp}" token="@FEATURE.CHART.WTP@"/>	
	</target>
	
	<target name="pushUpdateSiteLocal" if="createUpdateSite">

		<!-- push update site to output directory -->
		<mkdir dir="${postingDirectory}/${buildId}/UpdateSite/plugins"/>
		<mkdir dir="${postingDirectory}/${buildId}/UpdateSite/features"/>
		<copy todir="${postingDirectory}/${buildId}/UpdateSite/plugins">
			<fileset dir="${updateJarWorkingDir}/eclipse/plugins">
				<include name="**"/>
			</fileset>
		</copy>
		
		<copy todir="${postingDirectory}/${buildId}/UpdateSite/features">
			<fileset dir="${updateJarWorkingDir}/eclipse/features">
				<include name="**"/>
			</fileset>
		</copy>
		
		<copy tofile="${postingDirectory}/${buildId}/UpdateSite/site.xml" 
			file="${updateJarWorkingDir}/site/site.xml" overwrite="true"/>
		
		<!-- generate p2 meta-data -->
		<!--
		<p2.generator updatesite="file:${postingDirectory}/${buildId}/UpdateSite" 
		          site="file:${postingDirectory}/${buildId}/UpdateSite/site.xml"
		          compress="true" 
                  append="true" flavor="tooling" 
                  metadataRepository="file:${postingDirectory}/${buildId}/UpdateSite" 
                  artifactRepository="${postingDirectory}/${buildId}/UpdateSite" 
                  metadataRepositoryName="BIRT test" 
                  artifactRepositoryName="BIRT test" 
                  publishArtifacts="true" p2OS="linux" mode="incremental" /> 
		-->
		
		<!-- clean last content -->
		<delete failonerror="false">
			<fileset dir="${postingDirectory}/../../../UpdateSite/${package.version}">
				<include name="plugins/**"/>
				<include name="features/**"/>
				<include name="site.xml"/>
			</fileset>
		</delete>
		<!-- copy to internal update site -->
		<copy todir="${postingDirectory}/../../../UpdateSite/${package.version}/plugins" overwrite="true">
			<fileset dir="${updateJarWorkingDir}/eclipse/plugins">
				<include name="**"/>
			</fileset>
		</copy>
		<copy todir="${postingDirectory}/../../../UpdateSite/${package.version}/features" overwrite="true">
			<fileset dir="${updateJarWorkingDir}/eclipse/features/">
				<include name="**"/>
			</fileset>
		</copy>
		<copy tofile="${postingDirectory}/../../../UpdateSite/${package.version}/site.xml" file="${updateJarWorkingDir}/site/site.xml" overwrite="true"/>
	</target>
	
	<target name="runBirtTest" unless="skip.unit.test">
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="runBirtTest" >
			<property name="runner.dir" value="${eclipse.build.configs}/birt.tests/test.scripts" />
		</ant>
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="InformAutomation" >
			<property name="runner.dir" value="${eclipse.build.configs}/birt.tests/test.scripts" />
		</ant>

		<ant antfile="${eclipse.build.configs}/../helper.xml" target="genTestResultSummary" />
	</target>
	
	<target name="runBirtPerformance">
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="runBirtPerformance" >
			<property name="runner.dir" value="${eclipse.build.configs}/birt.tests/test.scripts" />
		</ant>
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="InformPerformance" >
			<property name="runner.dir" value="${eclipse.build.configs}/birt.tests/test.scripts" />
		</ant>
	</target>
	
	<target name="buildBirtTestFeature">
		
		<echo message="BIRT test feature build started"/>
		
		<ant antfile="build.xml" dir="${basedir}">
			<property name="component" value="${eclipse.build.configs}/birt.tests" />
		</ant>
		
		<echo message="BIRT test feature build finished"/>
		
	</target>
	
	<target name="buildBirtWtpFeature">
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="generate">
			<property name="builder" value="${eclipse.build.configs}/birt.wtp" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="process">
			<property name="builder" value="${eclipse.build.configs}/birt.wtp" />
		</ant>		
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="assemble">
			<property name="builder" value="${eclipse.build.configs}/birt.wtp" />
		</ant>		
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="package">
			<property name="builder" value="${eclipse.build.configs}/birt.wtp" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="postBuild">
			<property name="builder" value="${eclipse.build.configs}/birt.wtp" />
		</ant>
		
		<antcall target="signWTPJars"/>
		<!-- unpack BIRT wtp integration feature -->
		
		<mkdir dir="${buildDirectory}/wtptmpsite"/>
		<mkdir dir="${buildDirectory}/wtptmpsite/new"/>
		<property name="wtptmpsite" value="${buildDirectory}/wtptmpsite"/>
		
		<exec executable="unzip" dir="${buildDirectory}/${buildId}">
			<arg line="-o -q birt-wtp-integration-sdk-${package.version}.zip -d ${wtptmpsite}" />
		</exec>
		
		<unpackUpdateJars site="${wtptmpsite}/eclipse" output="${wtptmpsite}/new/eclipse"/>
		
		<exec executable="zip" dir="${wtptmpsite}/new">
			<arg line="-q ${postingDirectory}/${buildId}/birt-wtp-integration-sdk-${package.version}.zip -r eclipse" />
		</exec>
		
		<!-- verify compile result -->
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="verifyCompile" />

        <!--copy all packages to upload area-->
		<echo message="start copying birt-wtp-integration-sdk-*.zip to download area..."/>
        <copy todir="${test.dir}/../../downloads/${package.version}" failonerror="false" overwrite="true">
	        <fileset dir="${postingDirectory}/${buildId}" >
                <include name="birt-wtp-integration-sdk-2_5_0-20090316.zip"/>
            </fileset>
	    </copy>
		
		<antcall target="renameBirtWtpPackage"/>
		
	</target>
	
	<target name="buildBirtThirdPartyFeature">
		<echo message="Third party feature building started"/>
		<ant antfile="build.xml" dir="${basedir}">
			<property name="component" value="${eclipse.build.configs}/birt.third.party" />
		</ant>
		<echo message="Third party feature building finished"/>
	</target>
	<!-- - - - - - - - - - - - - - - - - - 
          target: buildBirtRCPFeature                      
         - - - - - - - - - - - - - - - - - -->
    <target name="buildBirtRCPFeature">

    	<echo message="Export BIRT RCP product started"/>
    	
    	<ant antfile="productBuild.xml" dir="${eclipse.pdebuild.scripts}/productBuild">
    		<property name="builder" value="${eclipse.build.configs}/birt.rcp"/>
    		<property name="product" value="${buildDirectory}/plugins/org.eclipse.birt.report.designer.ui.rcp/BIRT.product" />
    	</ant>
    	
    	<echo message="Export BIRT RCP product finished"/>
    </target>

	<target name="fetchBirtWtpFeature">
		<echo message="Fetch birt wtp integration feature started"/>
		
        <ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="preBuild">
            <property name="builder" value="${eclipse.build.configs}/birt.wtp" />
        </ant>
        <ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="fetch">
            <property name="builder" value="${eclipse.build.configs}/birt.wtp" />
        </ant>
		<echo message="Fetch birt wtp integration feature finished"/>
	</target>
	
	<target name="fetchRCP">
		<echo message="Fetch birt rcp plugin started"/>
		
        <ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="preBuild">
            <property name="builder" value="${eclipse.build.configs}/birt.designer.rcp" />
        </ant>
        <ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="fetch">
            <property name="builder" value="${eclipse.build.configs}/birt.designer.rcp" />
        </ant>
		<echo message="Fetch birt rcp plugin finished"/>
	</target>
	
	<target name="BuildChartViewer">
		<echo message="Fetch birt chart viewer started"/>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="preBuild">
			<property name="builder" value="${eclipse.build.configs}/birt.chart.viewer" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="fetch">
			<property name="builder" value="${eclipse.build.configs}/birt.chart.viewer" />
		</ant>
		<echo message="Fetch birt chart viewer finished"/>
	</target>

	<target name="buildBirtNLFeature">
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="preBuild">
			<property name="builder" value="${eclipse.build.configs}/birt.dtp.nl" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="fetch">
			<property name="builder" value="${eclipse.build.configs}/birt.dtp.nl" />
			<property name="fetchTag" value="HEAD" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="preBuild">
			<property name="builder" value="${eclipse.build.configs}/birt.nl" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="fetch">
			<property name="builder" value="${eclipse.build.configs}/birt.nl" />
			<property name="fetchTag" value="HEAD" />
		</ant>
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="buildLanguagePack" />
	</target>
	
	<target name="buildUpdateSite" if="updateSite">
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="buildUpdateJars" />
	</target>
	
	<target name="unpackUpdateJarsForPackaging">

		<property name="tmpsite" value="${buildDirectory}/tmpsite" />
	
		<mkdir dir="${tmpsite}/new/eclipse/features" />
		<mkdir dir="${tmpsite}/new/eclipse/plugins" />

		<!-- BIRT framework-->
		<exec executable="unzip" dir="${buildDirectory}/${buildId}">
			<arg line="-q birt-report-framework-sdk-${package.version}.zip -d ${tmpsite}" />
		</exec>
		<!-- BIRT third party -->
		<exec executable="unzip" dir="${buildDirectory}/${buildId}">
			<arg line="-o -q birt-third-party-${package.version}.zip -d ${tmpsite}" />
		</exec>
		
		<!-- backup un-signed and packed version -->
		<exec executable="zip" dir="${tmpsite}">
			<arg line="-q ${buildDirectory}/birt-all-${package.version}.bak.zip -r eclipse ${eclipse.build.configs}/../../extras/pack.properties" />
		</exec>		
		
		<!-- Sign packed features and plugins. 
		Download signed features and plugins back to replace ${tmpsite}/eclipse.
		Back signed features and plugins as update site jars 
		-->
		<antcall target="signBIRTJars"/>

		<!-- unpack features and plugins -->		
		<unpackUpdateJars site="${tmpsite}/eclipse" output="${tmpsite}/new/eclipse"/>

		<exec executable="zip" dir="${tmpsite}/new">
			<arg line="-q ${buildDirectory}/birt-all-${package.version}.zip -r eclipse" />
		</exec>
		
		<copy todir="${buildDirectory}/${buildId}" >
			<fileset dir="${tmpsite}/new">
				<include name="eclipse/**"/>
			</fileset>
		</copy>
		
	</target>

	<target name="signWTPJars" if="sign">
		
		<antcall target="SignJars">
			<param name="source.dir" value="${buildDirectory}/${buildId}"/>
			<param name="source.name" value="birt-wtp-integration-sdk-${package.version}.zip"/>
			<param name="target.dir" value="${buildDirectory}/${buildId}"/>
			<param name="target.name" value="birt-wtp-integration-sdk-${package.version}.sign.zip"/>
		</antcall>
		
		<move file="${buildDirectory}/${buildId}/birt-wtp-integration-sdk-${package.version}.sign.zip"
		      tofile="${buildDirectory}/${buildId}/birt-wtp-integration-sdk-${package.version}.zip" 
		      overwrite="true"/>
		
	</target>
	
	<target name="signBIRTJars" if="sign">
		
		<antcall target="SignJars">
			<param name="source.dir" value="${buildDirectory}"/>
			<param name="source.name" value="birt-all-${package.version}.bak.zip"/>
			<param name="target.dir" value="${buildDirectory}"/>
			<param name="target.name" value="birt-all-${package.version}.sign.zip"/>
		</antcall>
		
        <delete dir="${tmpsite}" failonerror="false" />
        <unzip src="${buildDirectory}/birt-all-${package.version}.sign.zip" dest="${tmpsite}"/>
 
	</target>
	
    <target name="SignJars">
    	
        <tstamp prefix="timestamp">
            <format property="upload" pattern="yyyy-MM-dd HH:mm:ss" locale="en" />
        </tstamp>
     	<echo message="[${timestamp.upload}] Upload ${source.name} to build.eclipse.org started"/>

    	<scp todir="${username.sign}:${password.sign}@${hostname.sign}:${home.dir}" trust="true">
            <fileset dir="${source.dir}" includes="${source.name}"/>
        </scp>

        <tstamp prefix="timestamp">
            <format property="sign" pattern="yyyy-MM-dd HH:mm:ss" locale="en" />
        </tstamp>
     	<echo message="[${timestamp.sign}] Upload ended. Wait for 30 mins for jarsigning..."/>

        <sshexec host="${hostname.sign}" username="${username.sign}" password="${password.sign}" trust="true"
             command="cd ${sign.dir};cp ${home.dir}/${source.name} ./;sign  ${source.name} nomail;"/>
        <sleep minutes="30"/>

    	<tstamp prefix="timestamp">
            <format property="download" pattern="yyyy-MM-dd HH:mm:ss" locale="en" />
        </tstamp>
     	<echo message="[${timestamp.download}] Download signed jars started"/>
    	
        <scp localtofile="${target.dir}/${target.name}" trust="true"
           file="${username.sign}:${password.sign}@${hostname.sign}:${sign.dir}/${source.name}"/>

    	<tstamp prefix="timestamp">
            <format property="download.end" pattern="yyyy-MM-dd HH:mm:ss" locale="en" />
        </tstamp>
     	<echo message="[${timestamp.download.end}] Download signed jars ended. Compare signed jars with unsigned."/>
    	
        <condition property="CompareSignPack" value="true">
            <filesmatch file1="${source.dir}/${source.name}"
                        file2="${target.dir}/${target.name}"/>
        </condition>
    	
    	<antcall target="DownloadSignedPackAgain">
    		<param name="source.name" value="${source.name}"/>
    		<param name="target.name" value="${target.name}"/>
    	    <param name="target.dir" value="${target.dir}"/>
    	</antcall>

    	<tstamp prefix="timestamp">
            <format property="package" pattern="yyyy-MM-dd HH:mm:ss" locale="en" />
        </tstamp>
     	<echo message="[${timestamp.package}] Packaging starts"/>

    </target>

    <target name="DownloadSignedPackAgain" if="CompareSignPack">
    	
    	<tstamp prefix="timestamp">
            <format property="download.again" pattern="yyyy-MM-dd HH:mm:ss" locale="en" />
        </tstamp>
     	<echo message="[${timestamp.download.again}] Compare fails. Wait 10 mins to download again..."/>

        <sleep minutes="10"/>
    	
    	<tstamp prefix="timestamp">
            <format property="download.again.start" pattern="yyyy-MM-dd HH:mm:ss" locale="en" />
        </tstamp>
        <echo message="[${timestamp.download.again}]  Download signed package started"/>
    	
        <scp localtofile="${target.dir}/${target.name}" trust="true"
             file="${username.sign}:${password.sign}@${hostname.sign}:${sign.dir}/${source.name}"/>
    	
    	<tstamp prefix="timestamp">
            <format property="download.again.end" pattern="yyyy-MM-dd HH:mm:ss" locale="en" />
        </tstamp>
        <echo message="[${timestamp.download.again.end}] Download signed package ended"/>
 
    </target>

	<target name="integrateBirtFeatures" />


	<target name="package">
		<ant antfile="package.xml" dir="${eclipse.pdebuild.scripts}">
			<property name="packagingInfo" value="${packagingInfo}" />
			<property name="assemblyTempDir" value="${packagingInfo}/jartmp" />
		</ant>
	</target>
	
    <target name="buildBirtWebViewer">
    	<echo message="Build BIRT web viewer started"/>
        <ant antfile="${eclipse.build.configs}/../helper.xml" target="BuildWebViewer" />
    	<echo message="Build BIRT web viewer finished"/>
    </target>

	<target name="generateJavaCrossReference" unless="skip.gen.JavaCrossRef">
        <ant antfile="${eclipse.build.configs}/../../extras/CrossReferenceGenerator.xml" 
        	target="generateJavaCrossReference" >
        </ant>
	</target>

	<target name="generateDocumentCheck" unless="skip.gen.DocuCheck">
        <ant antfile="${eclipse.build.configs}/../../extras/CrossReferenceGenerator.xml" 
        	target="generateDocumentCheck" >
        </ant>
	</target>
	
    <target name="generateJavaDoc" unless="skip.gen.JavaDoc">
        <ant antfile="${eclipse.build.configs}/../../extras/antJavadoc.xml"/>
    </target>

	
</project>
